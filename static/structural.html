<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>T√ÅCTICA INGENIER√çA ‚Äî Revisi√≥n Estructural</title>
  <link rel="icon" href="/static/favicon.ico"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue:#0066CC;--bl:#E8F2FF;--bm:#C8DFF7;
      --orange:#FF6B35;--ol:#FFF1EC;--om:rgba(255,107,53,.3);
      --green:#10B981;--gl:#ECFDF5;--gm:rgba(16,185,129,.3);
      --warn:#F59E0B;--danger:#EF4444;
      --g50:#F9FAFB;--g100:#F3F4F6;--g200:#E5E7EB;
      --g400:#9CA3AF;--g500:#6B7280;--g700:#374151;--g900:#111827;
      --white:#FFFFFF;
      --sh:0 4px 12px rgba(0,0,0,.07);--shs:0 1px 3px rgba(0,0,0,.08);
      --r:12px;--font:'Inter',ui-sans-serif,system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100%;background:var(--g50);color:var(--g900);font-family:var(--font);font-size:14px}
    a{color:inherit;text-decoration:none}
    .page{display:flex;flex-direction:column;min-height:100vh}
    /* TOAST */
    .toastHost{position:fixed;right:12px;top:12px;display:flex;flex-direction:column;gap:6px;z-index:9999;pointer-events:none}
    .toast{pointer-events:none;opacity:0;transform:translateY(-8px) scale(.97);transition:.2s ease;padding:10px 14px;border-radius:10px;border:1px solid var(--g200);background:rgba(255,255,255,.97);color:var(--g900);box-shadow:0 8px 24px rgba(0,0,0,.12);max-width:340px;font-size:12.5px;font-weight:500}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
    .toast.ok{border-left:3px solid var(--green)}
    .toast.warn{border-left:3px solid var(--warn)}
    .toast.err{border-left:3px solid var(--danger)}
    /* TOPNAV */
    .topnav{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.96);backdrop-filter:blur(12px);border-bottom:1px solid var(--g200);box-shadow:var(--shs);display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:52px;}
    .nav-brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:14px}
    .nav-logo{width:30px;height:30px;border-radius:7px;background:var(--blue);display:grid;place-items:center;font-weight:900;font-size:11px;color:#fff}
    .nav-links{display:flex;gap:2px}
    .nav-link{padding:5px 11px;border-radius:7px;font-size:13px;font-weight:500;color:var(--g500);transition:.12s background,.12s color}
    .nav-link:hover{background:var(--g100);color:var(--g900)}
    .nav-link.active{background:var(--bl);color:var(--blue);font-weight:600}
    .nav-right{display:flex;gap:8px;align-items:center}
    /* AI BADGE */
    .ai-badge{font-size:10.5px;padding:3px 9px;border-radius:999px;border:1px solid var(--bm);background:var(--bl);color:var(--blue);font-weight:700;white-space:nowrap;font-family:var(--mono)}
    .ai-badge.demo{border-color:rgba(239,68,68,.3);background:#FEF2F2;color:var(--danger)}
    select{background:var(--white);border:1px solid var(--g200);color:var(--g700);padding:6px 10px;border-radius:8px;outline:none;font-size:12.5px;font-family:var(--font);box-shadow:var(--shs)}
    /* BUTTONS */
    .btn{padding:8px 14px;border-radius:8px;border:1px solid var(--g200);background:var(--white);color:var(--g700);cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:7px;user-select:none;white-space:nowrap;font-family:var(--font);box-shadow:var(--shs);transition:.12s transform,.12s background,.12s border-color;}
    .btn:hover{transform:translateY(-1px);background:var(--g50)}
    .btn.pri{background:var(--blue);color:#fff;border-color:var(--blue);box-shadow:0 2px 8px rgba(0,102,204,.25)}
    .btn.pri:hover{background:#0055B3}
    .btn.grn{background:var(--green);color:#fff;border-color:var(--green)}
    .btn.grn:hover{background:#0DA271}
    .btn.orn{background:var(--orange);color:#fff;border-color:var(--orange)}
    .btn.orn:hover{background:#E85C27}
    .btn.dng{background:#FEF2F2;color:var(--danger);border-color:rgba(239,68,68,.3)}
    .btn.obl{background:var(--bl);color:var(--blue);border-color:var(--bm);font-weight:700}
    .btn.ogrn{background:var(--gl);color:var(--green);border-color:var(--gm);font-weight:700}
    .btn.oorn{background:var(--ol);color:var(--orange);border-color:var(--om);font-weight:700}
    /* CONTENT */
    .content{max-width:1200px;margin:0 auto;padding:18px 20px 32px;display:flex;flex-direction:column;gap:14px;flex:1}
    /* HEADER STRIP */
    .hstrip{background:var(--white);border:1px solid var(--g200);border-radius:var(--r);padding:14px 18px;box-shadow:var(--shs);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .hs-left h2{font-size:16px;font-weight:700;margin-bottom:2px}
    .hs-left span{font-size:12px;color:var(--g500);font-family:var(--mono)}
    /* NORMA BAR */
    .norma-bar{background:var(--white);border:1px solid var(--g200);border-radius:10px;padding:12px 16px;box-shadow:var(--shs);display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .norma-label{font-size:11px;font-weight:700;color:var(--g400);text-transform:uppercase;letter-spacing:.5px}
    .norma-bar input{background:var(--g50);border:1px solid var(--g200);color:var(--g900);padding:7px 11px;border-radius:8px;outline:none;font-size:13px;font-family:var(--font);}
    .norma-bar input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,102,204,.1)}
    .norma-note{font-size:12px;color:var(--g400);flex:1}
    /* PANELS */
    .panels{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.panels{grid-template-columns:1fr}}
    .panel-card{background:var(--white);border:1px solid var(--g200);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
    .panel-head{padding:12px 16px;border-bottom:1px solid var(--g200);display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--g50);}
    .panel-head-title{font-size:12px;font-weight:700;color:var(--g600,#4B5563);display:flex;align-items:center;gap:7px}
    .panel-head-title::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--dot-color,var(--blue))}
    .panel-body{padding:16px}
    /* DROP ZONE */
    .drop-zone{border:2px dashed var(--g200);border-radius:10px;padding:28px 16px;text-align:center;color:var(--g400);font-size:13px;transition:.15s border-color,.15s background;cursor:pointer;}
    .drop-zone:hover,.drop-zone.drag{border-color:var(--blue);background:var(--bl);color:var(--blue)}
    .drop-icon{font-size:32px;margin-bottom:8px;display:block;opacity:.4}
    .drop-hint{font-size:11.5px;margin-top:5px;font-family:var(--mono);color:var(--g400)}
    /* FILE CHIP */
    .file-chip{display:none;align-items:center;gap:6px;padding:4px 10px;border-radius:8px;background:var(--bl);border:1px solid var(--bm);font-size:11.5px;font-weight:600;color:var(--blue);max-width:180px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.file-chip:not(:empty){display:inline-flex}
    /* ACTION BAR */
    .action-bar{background:var(--white);border:1px solid var(--g200);border-radius:10px;padding:12px 16px;box-shadow:var(--shs);display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .status-bar{flex:1;font-size:12px;color:var(--g500);font-family:var(--mono);padding:7px 10px;border-radius:8px;border:1px solid var(--g200);background:var(--g50);min-width:140px}
    /* FINDINGS */
    .findings-card{background:var(--white);border:1px solid var(--g200);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
    .findings-head{padding:12px 16px;border-bottom:1px solid var(--g200);background:var(--g50);font-size:12px;font-weight:700;color:var(--g600,#4B5563);display:flex;align-items:center;gap:7px;}
    .findings-head::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--orange)}
    .findings-body{padding:14px;display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto}
    .item{padding:10px 12px;border-radius:8px;border:1px solid var(--g100);background:var(--g50);font-size:12.5px;line-height:1.4;}
    .item[data-sev="alta"]{border-color:rgba(239,68,68,.3);background:#FEF2F2}
    .item[data-sev="media"]{border-color:rgba(245,158,11,.3);background:#FFFBEB}
    .item[data-sev="baja"]{border-color:var(--gm);background:var(--gl)}
    /* CHAT */
    .chat-card{background:var(--white);border:1px solid var(--g200);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
    .chat-head{padding:12px 16px;border-bottom:1px solid var(--g200);background:var(--g50);display:flex;align-items:center;justify-content:space-between;}
    .chat-head-title{font-size:13px;font-weight:700;color:var(--g800,#1F2937);display:flex;align-items:center;gap:8px}
    #chat{min-height:200px;max-height:280px;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:7px;background:var(--g50)}
    .bubble{border:1px solid var(--g200);border-radius:8px;padding:9px 11px;background:var(--white);font-size:12.5px;line-height:1.5;white-space:pre-wrap;color:var(--g700)}
    .bubble.me{border-color:var(--bm);background:var(--bl);color:var(--blue);border-left:3px solid var(--blue)}
    .bubble.ai{border-left:3px solid var(--orange);background:var(--ol);border-color:var(--om)}
    .chat-composer{display:flex;gap:8px;align-items:center;padding:12px 14px;border-top:1px solid var(--g200)}
    #message{flex:1;padding:9px 12px;border-radius:8px;border:1px solid var(--g200);background:var(--white);color:var(--g900);outline:none;font-size:13px;font-family:var(--font);}
    #message:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,102,204,.1)}
    .chat-hint{font-size:11px;color:var(--g400);padding:0 14px 10px;font-family:var(--mono)}
    /* DOWNLOAD ROW */
    .dl-row{display:flex;gap:6px;flex-wrap:wrap}
    .dl-btn{padding:6px 10px;border-radius:7px;border:1px solid var(--g200);background:var(--g50);color:var(--g600,#4B5563);font-size:11.5px;font-weight:600;cursor:pointer;text-align:center;transition:.12s background,.12s border-color;font-family:var(--font);}
    .dl-btn:hover{background:var(--bl);border-color:var(--bm);color:var(--blue)}
    .foot{text-align:center;font-size:12px;color:var(--g400);padding:12px;border-top:1px solid var(--g200);background:var(--white)}
    /* VISOR DE PLANO Y CARTILLA */
    #planVisorWrap,#rebarVisorWrap{display:none;margin-top:10px;border-radius:10px;overflow:hidden;border:1px solid var(--g200);background:#000;position:relative;}
    #planVisor,#rebarVisor{width:100%;height:300px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
    #planVisor img,#rebarVisor img{max-width:100%;max-height:300px;object-fit:contain;display:block;}
    #planVisor object,#planVisor iframe,#rebarVisor object,#rebarVisor iframe{width:100%;height:300px;border:0;}
    #btnQuitarPlano,#btnQuitarCartilla{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.65);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11.5px;font-weight:600;cursor:pointer;font-family:var(--font);z-index:2;}
    #btnQuitarPlano:hover,#btnQuitarCartilla:hover{background:rgba(0,0,0,.9);}
    /* BANNER GENERAR INFORME */
    .report-banner{background:linear-gradient(135deg,var(--bl),var(--ol));border:1px solid var(--bm);border-radius:10px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
    .report-banner-left strong{font-size:13.5px;font-weight:700;color:var(--g900);display:block;}
    .report-banner-left span{font-size:11.5px;color:var(--g500);font-family:var(--mono);}
    .report-banner-btns{display:flex;gap:6px;flex-wrap:wrap;}
  </style>
  <style>
    /* ===== NAVY DARK THEME - T√ÅCTICA INGENIER√çA ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
      --dk-bg: #080B18;
      --dk-surface: #0D1120;
      --dk-surface2: #111827;
      --dk-surface3: #151E2E;
      --dk-border: rgba(99,120,180,.2);
      --dk-border2: rgba(99,120,180,.35);
      --dk-glow-purple: rgba(120,80,220,.18);
      --dk-glow-cyan: rgba(34,193,195,.12);
      --dk-glow-green: rgba(16,185,129,.12);
      --dk-text: #E2E8F0;
      --dk-muted: #8B9BAE;
      --dk-dim: #4A6580;
    }

    html, body {
      background: var(--dk-bg) !important;
      background-image:
        radial-gradient(ellipse 900px 600px at 15% 5%, rgba(100,60,200,.12) 0%, transparent 55%),
        radial-gradient(ellipse 700px 500px at 85% 10%, rgba(34,193,195,.07) 0%, transparent 50%),
        radial-gradient(ellipse 600px 800px at 50% 100%, rgba(60,80,180,.08) 0%, transparent 55%) !important;
      background-attachment: fixed !important;
      color: var(--dk-text) !important;
    }

    /* TOPBAR / NAV */
    .topbar, .topnav {
      background: rgba(8,11,24,.88) !important;
      backdrop-filter: blur(16px) !important;
      border-bottom-color: var(--dk-border) !important;
      box-shadow: 0 1px 0 rgba(99,120,180,.15) !important;
    }
    .brand-info strong { color: #E2E8F0 !important; }
    .brand-info span { color: var(--dk-muted) !important; }
    .brand-logo, .nav-logo {
      background: linear-gradient(135deg,#7C3AED,#5B21B6) !important;
      box-shadow: 0 2px 12px rgba(124,58,237,.45) !important;
    }

    /* NAV LINKS */
    .nav a, .nav-link {
      color: var(--dk-muted) !important;
      border-color: transparent !important;
    }
    .nav a:hover, .nav-link:hover {
      background: rgba(99,120,180,.12) !important;
      color: var(--dk-text) !important;
    }
    .nav a.active, .nav-link.active {
      background: rgba(124,58,237,.2) !important;
      color: #A78BFA !important;
      border-color: rgba(124,58,237,.4) !important;
      font-weight: 700 !important;
    }

    /* ICONBAR */
    .iconbar {
      background: rgba(8,11,24,.95) !important;
      border-right-color: var(--dk-border) !important;
    }
    .icon {
      background: var(--dk-surface2) !important;
      border-color: var(--dk-border) !important;
      color: var(--dk-muted) !important;
    }
    .icon:hover {
      background: rgba(124,58,237,.2) !important;
      border-color: rgba(124,58,237,.45) !important;
      color: #A78BFA !important;
    }
    .icon.active {
      background: rgba(124,58,237,.25) !important;
      border-color: rgba(124,58,237,.6) !important;
      color: #C4B5FD !important;
    }

    /* TOOLBAR / ACTION STRIP */
    .toolbar, .action-strip {
      background: rgba(13,17,32,.8) !important;
      border-color: var(--dk-border) !important;
      backdrop-filter: blur(8px) !important;
    }

    /* ALL CARDS / PANELS */
    .panel-card, .right, .cmd, .hstrip, .main-card,
    .upload-card, .chat-card, .section-card,
    [class*="-card"], [class*="-panel"] {
      background: rgba(13,17,32,.7) !important;
      border-color: var(--dk-border) !important;
      backdrop-filter: blur(8px) !important;
      color: var(--dk-text) !important;
    }

    /* RIGHT PANEL */
    .right {
      background: rgba(8,11,24,.9) !important;
      border-left-color: var(--dk-border) !important;
    }

    /* CMD BAR */
    .cmd {
      border-top-color: var(--dk-border) !important;
      background: rgba(8,11,24,.95) !important;
    }
    .cmd input {
      background: rgba(13,17,32,.9) !important;
      border-color: var(--dk-border2) !important;
      color: var(--dk-text) !important;
    }
    .cmd input:focus {
      border-color: rgba(124,58,237,.6) !important;
      box-shadow: 0 0 0 3px rgba(124,58,237,.15) !important;
    }
    .cmd input::placeholder { color: var(--dk-dim) !important; }

    /* MAIN VIEWER AREA */
    .main { background: transparent !important; }
    .viewer {
      background: #050810 !important;
      border-color: var(--dk-border) !important;
      box-shadow: inset 0 2px 12px rgba(0,0,0,.5), 0 0 0 1px rgba(99,120,180,.1) !important;
    }

    /* PANEL HEADER */
    .panel-header { border-bottom-color: var(--dk-border) !important; }
    .panel-title { color: var(--dk-muted) !important; }

    /* BUTTONS - Base */
    .btn {
      background: rgba(13,17,32,.8) !important;
      border-color: var(--dk-border2) !important;
      color: var(--dk-muted) !important;
      box-shadow: 0 1px 4px rgba(0,0,0,.3) !important;
    }
    .btn:hover:not(:disabled) {
      background: rgba(20,25,45,.9) !important;
      color: var(--dk-text) !important;
      border-color: rgba(99,120,180,.5) !important;
      transform: translateY(-1px) !important;
    }

    /* COLORED BUTTONS - matching the mockup */
    .btn.primary, .btn[class*="primary"] {
      background: linear-gradient(135deg,#2563EB,#1D4ED8) !important;
      border-color: #3B82F6 !important;
      color: #fff !important;
      box-shadow: 0 2px 12px rgba(37,99,235,.45) !important;
    }
    .btn.primary:hover { background: linear-gradient(135deg,#1D4ED8,#1E40AF) !important; box-shadow: 0 4px 20px rgba(37,99,235,.55) !important; }

    .btn.green, .btn.grn {
      background: linear-gradient(135deg,#059669,#047857) !important;
      border-color: #10B981 !important;
      color: #fff !important;
      box-shadow: 0 2px 12px rgba(5,150,105,.45) !important;
    }
    .btn.green:hover, .btn.grn:hover { background: linear-gradient(135deg,#047857,#065F46) !important; }

    .btn.orange, .btn.orn {
      background: linear-gradient(135deg,#D97706,#B45309) !important;
      border-color: #F59E0B !important;
      color: #fff !important;
      box-shadow: 0 2px 12px rgba(217,119,6,.45) !important;
    }
    .btn.orange:hover, .btn.orn:hover { background: linear-gradient(135deg,#B45309,#92400E) !important; }

    .btn.purple {
      background: linear-gradient(135deg,#7C3AED,#6D28D9) !important;
      border-color: #8B5CF6 !important;
      color: #fff !important;
      box-shadow: 0 2px 12px rgba(124,58,237,.45) !important;
    }
    .btn.purple:hover { background: linear-gradient(135deg,#6D28D9,#5B21B6) !important; }

    .btn.dng {
      background: linear-gradient(135deg,#DC2626,#B91C1C) !important;
      border-color: #EF4444 !important;
      color: #fff !important;
      box-shadow: 0 2px 12px rgba(220,38,38,.4) !important;
    }
    .btn.dng:hover { background: linear-gradient(135deg,#B91C1C,#991B1B) !important; }

    .btn.outline-orange, .btn.oorn {
      background: rgba(217,119,6,.15) !important;
      border-color: rgba(245,158,11,.4) !important;
      color: #FCD34D !important;
    }
    .btn.outline-green, .btn.ogrn {
      background: rgba(5,150,105,.15) !important;
      border-color: rgba(16,185,129,.4) !important;
      color: #34D399 !important;
    }
    .btn.outline-purple, .btn.obl, .btn.pri {
      background: rgba(124,58,237,.15) !important;
      border-color: rgba(139,92,246,.4) !important;
      color: #A78BFA !important;
    }

    /* AI BADGE */
    .ai-badge {
      background: rgba(124,58,237,.2) !important;
      border-color: rgba(139,92,246,.4) !important;
      color: #A78BFA !important;
    }

    /* MEASUREMENT ITEMS */
    .item {
      background: rgba(13,17,32,.6) !important;
      border-color: var(--dk-border) !important;
    }
    .item:hover {
      background: rgba(124,58,237,.15) !important;
      border-color: rgba(139,92,246,.4) !important;
    }

    /* BUBBLES / AI LOG */
    .bubble {
      background: rgba(13,17,32,.7) !important;
      border-color: var(--dk-border) !important;
      color: var(--dk-text) !important;
    }
    .bubble.ai { border-left-color: #7C3AED !important; }
    .bubble.user { border-left-color: #2563EB !important; }

    /* INPUTS / SELECTS / TEXTAREAS */
    input, select, textarea {
      background: rgba(13,17,32,.85) !important;
      border-color: var(--dk-border2) !important;
      color: var(--dk-text) !important;
    }
    input::placeholder, textarea::placeholder { color: var(--dk-dim) !important; }
    select option { background: #0D1120; color: #E2E8F0; }
    input:focus, select:focus, textarea:focus {
      border-color: rgba(124,58,237,.6) !important;
      box-shadow: 0 0 0 3px rgba(124,58,237,.12) !important;
      outline: none !important;
    }

    /* DROP ZONES */
    .drop-zone, [id*="drop"], [class*="drop"] {
      background: rgba(13,17,32,.5) !important;
      border-color: rgba(99,120,180,.25) !important;
    }

    /* PILLS / BADGES */
    .pill {
      background: rgba(13,17,32,.8) !important;
      border-color: var(--dk-border) !important;
      color: var(--dk-muted) !important;
    }

    /* TABLES */
    th {
      background: rgba(8,11,24,.8) !important;
      color: var(--dk-muted) !important;
      border-color: var(--dk-border) !important;
    }
    td { border-color: var(--dk-border) !important; color: var(--dk-text) !important; }
    tr:nth-child(even) { background: rgba(13,17,32,.4) !important; }
    tr:hover { background: rgba(124,58,237,.08) !important; }

    /* HUD CHIPS */
    .hud-chip {
      background: rgba(8,11,24,.85) !important;
      border-color: rgba(99,120,180,.2) !important;
      color: rgba(226,232,240,.7) !important;
    }

    /* TOASTS */
    .toast, #toast {
      background: rgba(13,17,32,.96) !important;
      border-color: var(--dk-border2) !important;
      color: var(--dk-text) !important;
      backdrop-filter: blur(12px) !important;
    }

    /* DIVIDERS */
    .divider { background: var(--dk-border) !important; }

    /* TEXT COLORS */
    h1,h2,h3,h4,h5,h6 { color: var(--dk-text) !important; }
    .tlabel { color: var(--dk-dim) !important; }

    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: rgba(8,11,24,.5); }
    ::-webkit-scrollbar-thumb { background: rgba(99,120,180,.3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(124,58,237,.5); }

    /* ===== END NAVY DARK THEME ===== */
  </style>

  <style>
    /* ===== DARK CARDS & PANELS FIX ===== */

    /* Override CSS variables to dark values */
    :root {
      --white: #0D1120 !important;
      --gray-50: #080B18 !important;
      --gray-100: #111827 !important;
      --gray-200: rgba(99,120,180,.22) !important;
      --gray-400: #4A6580 !important;
      --gray-500: #8B9BAE !important;
      --gray-600: #9CA8BB !important;
      --gray-700: #C8D3E0 !important;
      --gray-900: #E2E8F0 !important;
      --g50: #080B18 !important;
      --g100: #111827 !important;
      --g200: rgba(99,120,180,.22) !important;
      --g400: #4A6580 !important;
      --g500: #8B9BAE !important;
      --g700: #C8D3E0 !important;
      --g900: #E2E8F0 !important;
      --blue-light: rgba(37,99,235,.15) !important;
      --blue-mid: rgba(59,130,246,.35) !important;
      --bl: rgba(37,99,235,.15) !important;
      --bm: rgba(59,130,246,.35) !important;
      --orange-light: rgba(217,119,6,.12) !important;
      --orange-mid: rgba(245,158,11,.3) !important;
      --ol: rgba(217,119,6,.12) !important;
      --om: rgba(245,158,11,.3) !important;
      --green-light: rgba(5,150,105,.12) !important;
      --green-mid: rgba(16,185,129,.3) !important;
      --gl: rgba(5,150,105,.12) !important;
      --gm: rgba(16,185,129,.3) !important;
      --purple-light: rgba(124,58,237,.12) !important;
      --sh: 0 4px 16px rgba(0,0,0,.5) !important;
      --shs: 0 1px 4px rgba(0,0,0,.4) !important;
      --shadow-sm: 0 1px 4px rgba(0,0,0,.4) !important;
      --shadow: 0 4px 16px rgba(0,0,0,.5) !important;
      --shadow-md: 0 8px 24px rgba(0,0,0,.6) !important;
    }

    /* Force all text to be light */
    body, body * {
      color: #E2E8F0;
    }

    /* Specific overrides for elements that might still show white */
    .bubble, .ai-bubble, [class*="bubble"] {
      background: #111827 !important;
      border-color: rgba(99,120,180,.25) !important;
      color: #E2E8F0 !important;
    }

    /* Chat areas */
    [class*="chat"], [id*="chat"] {
      background: #0D1120 !important;
      color: #E2E8F0 !important;
    }

    /* Upload zones - dashed border areas */
    [class*="upload"], [id*="upload"],
    [class*="drop"], [id*="drop"] {
      background: rgba(8,11,24,.7) !important;
      border-color: rgba(99,120,180,.3) !important;
      color: #8B9BAE !important;
    }

    /* Stats / info pills inside cards */
    [class*="stat"], [class*="info-"] {
      background: #111827 !important;
      border-color: rgba(99,120,180,.2) !important;
      color: #E2E8F0 !important;
    }

    /* Section headers inside cards */
    .hstrip, [class*="hstrip"], [class*="header-strip"] {
      background: #0D1120 !important;
      border-color: rgba(99,120,180,.2) !important;
    }

    /* Instruction / helper text */
    [class*="hint"], [class*="help"], [class*="tip"], pre, code {
      background: rgba(8,11,24,.6) !important;
      color: #8B9BAE !important;
    }

    /* Selection / project dropdowns */
    .project-select, [class*="proj-"], [id*="proj"] {
      background: #111827 !important;
      color: #E2E8F0 !important;
    }

    /* Bold text should be white/bright */
    strong, b, h1, h2, h3, h4, h5, h6,
    [class*="-title"], [class*="-name"],
    .brand-info strong {
      color: #F0F4F8 !important;
      font-weight: 700 !important;
    }

    /* Muted / secondary text */
    [class*="-sub"], [class*="-desc"], [class*="-hint"],
    [class*="-meta"], [class*="-label"], small, .brand-info span {
      color: #8B9BAE !important;
    }

    /* Borders globally */
    [class*="-card"], [class*="-panel"], [class*="-section"],
    [class*="-zone"], [class*="-strip"], [class*="-wrap"] {
      border-color: rgba(99,120,180,.2) !important;
    }

    /* ===== END FIX ===== */
  </style>

</head>
<body>
  <div class="toastHost" id="toastHost"></div>
  <div class="page">
    <!-- NAV -->
    <nav class="topnav">
      <div class="nav-brand">
        <div class="nav-logo">TI</div>
        <span>T√ÅCTICA INGENIER√çA</span>
      </div>
      <div class="nav-links">
        <a class="nav-link" href="/static/index.html">Inicio</a>
        <a class="nav-link" href="/static/viewer.html">üìê Medici√≥n</a>
        <a class="nav-link active" href="/static/structural.html">üèóÔ∏è Estructural</a>
        <a class="nav-link" href="/static/budget_advanced.html">üí∞ Costos</a>
        <a class="nav-link" href="/static/projects.html">üìÅ Proyectos</a>
      </div>
      <div class="nav-right">
        <span class="ai-badge" id="aiBadge">‚ö° GPT-4o</span>
        <select id="projectSelect" style="max-width:200px"></select>
        <button class="btn pri" style="font-size:12px;padding:6px 12px" id="btnNewProject">‚ûï Proyecto</button>
      </div>
    </nav>

    <div class="content">
      <!-- HEADER -->
      <div class="hstrip">
        <div class="hs-left">
          <h2>üèóÔ∏è Revisi√≥n Estructural y Ferreter√≠a</h2>
          <span id="subTitle">Sin proyecto activo</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="ai-badge" id="chatAiBadge">GPT-4o Vision</span>
        </div>
      </div>

      <!-- NORMA BAR -->
      <div class="norma-bar">
        <span class="norma-label">Pa√≠s / Norma</span>
        <input id="country" value="ESPA√ëA" placeholder="Pa√≠s" style="width:110px"/>
        <input id="standard" placeholder="Norma (ej: EHE-08, NSR-10)" style="flex:1;max-width:280px"/>
        <span class="norma-note" id="normaNote">Selector inteligente ‚Äî conectar a DB de normas para autocompletar</span>
      </div>

      <!-- DUAL PANELS -->
      <div class="panels">
        <!-- PLANO -->
        <div class="panel-card">
          <div class="panel-head">
            <div class="panel-head-title" style="--dot-color:var(--blue)">Plano estructural</div>
            <div style="display:flex;gap:7px;align-items:center">
              <button class="btn obl" id="btnPlan" style="font-size:12px;padding:6px 10px">‚Üë Cargar Plano</button>
              <input id="planInput" type="file" accept=".pdf,.png,.jpg,.jpeg,.webp" hidden/>
              <span id="planName" class="file-chip"></span>
            </div>
          </div>
          <div class="panel-body">
            <div class="drop-zone" id="dropPlan">
              <span class="drop-icon">üèóÔ∏è</span>
              <div><b>Suelta aqu√≠ el plano</b></div>
              <div style="margin-top:4px">PDF ¬∑ PNG ¬∑ JPG ¬∑ WEBP</div>
              <div class="drop-hint">O haz clic para seleccionar</div>
            </div>
            <!-- VISOR: aparece cuando se carga un plano -->
            <div id="planVisorWrap">
              <div id="planVisor"></div>
              <button id="btnQuitarPlano">‚úï Quitar plano</button>
            </div>
          </div>
        </div>

        <!-- CARTILLA -->
        <div class="panel-card">
          <div class="panel-head">
            <div class="panel-head-title" style="--dot-color:var(--orange)">Cartilla de hierro</div>
            <div style="display:flex;gap:7px;align-items:center">
              <button class="btn oorn" id="btnRebar" style="font-size:12px;padding:6px 10px">‚Üë Cargar Cartilla</button>
              <input id="rebarInput" type="file" accept=".pdf,.png,.jpg,.jpeg,.xlsx,.xls,.csv" hidden/>
              <span id="rebarName" class="file-chip"></span>
            </div>
          </div>
          <div class="panel-body">
            <div class="drop-zone" id="dropRebar">
              <span class="drop-icon">üìã</span>
              <div><b>Suelta aqu√≠ la cartilla</b></div>
              <div style="margin-top:4px">PDF ¬∑ Excel ¬∑ CSV</div>
              <div class="drop-hint">O haz clic para seleccionar</div>
            </div>
            <!-- VISOR: aparece cuando se carga la cartilla -->
            <div id="rebarVisorWrap">
              <div id="rebarVisor"></div>
              <button id="btnQuitarCartilla">‚úï Quitar cartilla</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTION BAR -->
      <div class="action-bar">
        <button class="btn grn" id="btnVerify">‚úì Verificar Cartilla vs Plano (IA)</button>
        <button class="btn dng" id="btnClear">‚úï Limpiar</button>
        <div class="status-bar" id="verifyStatus">Listo. Carga ambos archivos y verifica.</div>
        <div class="dl-row">
          <button class="dl-btn" id="dlPdf">‚Üì PDF</button>
          <button class="dl-btn" id="dlExcel">‚Üì Excel</button>
          <button class="dl-btn" id="dlWord">‚Üì Word</button>
        </div>
      </div>

      <!-- FINDINGS -->
      <div class="findings-card" id="findingsCard" style="">
        <div class="findings-head">Hallazgos de verificaci√≥n IA</div>
        <div class="findings-body" id="findingsList">
          <div style="color:var(--g400);font-size:12.5px;text-align:center;padding:12px;font-family:var(--mono)">
            Los hallazgos aparecer√°n aqu√≠ tras verificar.
          </div>
        </div>
      </div>

      <!-- GENERAR INFORME DESDE AN√ÅLISIS IA -->
      <div class="report-banner">
        <div class="report-banner-left">
          <strong>üìÑ Generar informe desde an√°lisis IA</strong>
          <span>Convierte el chat en PDF ¬∑ Excel ¬∑ Word ‚Äî sin necesitar la cartilla</span>
        </div>
        <div class="report-banner-btns">
          <button class="dl-btn" id="btnRptPdf" style="background:var(--white);padding:7px 14px;">‚Üì PDF</button>
          <button class="dl-btn" id="btnRptExcel" style="background:var(--white);padding:7px 14px;">‚Üì Excel</button>
          <button class="dl-btn" id="btnRptWord" style="background:var(--white);padding:7px 14px;">‚Üì Word</button>
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat-card">
        <div class="chat-head">
          <div class="chat-head-title">üí¨ Chat IA <span style="font-size:11px;color:var(--g400);font-family:var(--mono)">(contexto estructural)</span></div>
          <span class="ai-badge">GPT-4o Vision</span>
        </div>
        <div id="chat"></div>
        <div class="chat-composer">
          <input id="message" placeholder="Ej: ¬øHay discrepancia en viga Eje B? ¬øCumple norma EHE-08 en columnas?"/>
          <button class="btn pri" id="btnSend">Enviar ‚Üí</button>
        </div>
        <div class="chat-hint">Tip: el chat puede analizar ambos archivos para respuestas con contexto completo.</div>
      </div>
    </div>
    <div class="foot">‚ö° Del plano al dato, sin drama ¬∑ T√ÅCTICA INGENIER√çA v2.0 ¬∑ 2026</div>
  </div>

  <script>
  // planName/rebarName now show as chips after file selection
  </script>

<script>
(() => {
  "use strict";
  const API = "/api/v1";
  const STORAGE_KEY = "TACTICA_ACTIVE_PROJECT";

  const $ = (id) => document.getElementById(id);
  const el = {
    projectSelect: $("projectSelect"),
    btnNewProject: $("btnNewProject"),
    subTitle: $("subTitle"),
    country: $("country"),
    standard: $("standard"),
    planInput: $("planInput"),
    rebarInput: $("rebarInput"),
    btnPlan: $("btnPlan"),
    btnRebar: $("btnRebar"),
    planName: $("planName"),
    rebarName: $("rebarName"),
    dropPlan: $("dropPlan"),
    dropRebar: $("dropRebar"),
    btnVerify: $("btnVerify"),
    btnClear: $("btnClear"),
    verifyStatus: $("verifyStatus"),
    dlPdf: $("dlPdf"),
    dlExcel: $("dlExcel"),
    dlWord: $("dlWord"),
    chat: $("chat"),
    message: $("message"),
    btnSend: $("btnSend"),
    findingsList: $("findingsList"),
  };

  const state = {
    projects: [],
    activeProjectId: localStorage.getItem(STORAGE_KEY) || "",
    activeProject: null,
    plan: null,
    rebar: null,
    lastFiles: {}
  };

  function bubble(text, cls="sys"){
    const d = document.createElement("div");
    d.className = "bubble " + cls;
    d.textContent = text;
    el.chat.appendChild(d);
    el.chat.scrollTop = el.chat.scrollHeight;
  }

  async function loadProjects(){
    const res = await fetch(`${API}/projects`);
    const data = await res.json();
    state.projects = data.projects || [];
    if(state.activeProjectId){
      state.activeProject = state.projects.find(p => p.id === state.activeProjectId) || null;
    }
    if(!state.activeProject && state.projects.length){
      state.activeProject = state.projects[0];
      state.activeProjectId = state.activeProject.id;
      localStorage.setItem(STORAGE_KEY, state.activeProjectId);
    }

    el.projectSelect.innerHTML = "";
    if(!state.projects.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sin proyectos (crea uno)";
      el.projectSelect.appendChild(opt);
      state.activeProject = null;
      state.activeProjectId = "";
    } else {
      for(const p of state.projects){
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name}${p.location ? " ‚Äî " + p.location : ""}`;
        if(p.id === state.activeProjectId) opt.selected = true;
        el.projectSelect.appendChild(opt);
      }
    }
    el.subTitle.textContent = state.activeProject ? state.activeProject.name : "Sin proyecto activo";
  }

  async function createProject(){
    const name = prompt("Nombre del proyecto:");
    if(!name) return;
    const location = prompt("Ubicaci√≥n (opcional):") || "";
    const currency = (prompt("Moneda (COP, USD, EUR):", "COP") || "COP").toUpperCase();
    const fd = new FormData();
    fd.append("name", name);
    fd.append("location", location);
    fd.append("currency", currency);
    const res = await fetch(`${API}/projects`, { method:"POST", body: fd });
    if(!res.ok){ bubble("No pude crear el proyecto.", "sys"); return; }
    const data = await res.json();
    state.activeProjectId = data.id;
    localStorage.setItem(STORAGE_KEY, state.activeProjectId);
    await loadProjects();
  }

  el.projectSelect.addEventListener("change", () => {
    state.activeProjectId = el.projectSelect.value || "";
    localStorage.setItem(STORAGE_KEY, state.activeProjectId);
    state.activeProject = state.projects.find(p => p.id === state.activeProjectId) || null;
    el.subTitle.textContent = state.activeProject ? state.activeProject.name : "Sin proyecto activo";
  });
  el.btnNewProject.addEventListener("click", createProject);

  // file load
  el.btnPlan.addEventListener("click", () => el.planInput.click());
  el.btnRebar.addEventListener("click", () => el.rebarInput.click());

  el.planInput.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    state.plan = f;
    el.planName.textContent = f.name;
    bubble("Plano cargado ‚úÖ", "sys");
  });
  el.rebarInput.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    state.rebar = f;
    el.rebarName.textContent = f.name;
    bubble("Cartilla cargada ‚úÖ", "sys");
  });

  function bindDrop(zone, setter){
    ["dragenter","dragover"].forEach(ev => zone.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation(); zone.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(ev => zone.addEventListener(ev, (e) => {
      e.preventDefault(); e.stopPropagation(); zone.classList.remove("drag");
    }));
    zone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(!f) return;
      setter(f);
    });
  }

  bindDrop(el.dropPlan, (f) => { state.plan = f; el.planName.textContent = f.name; bubble("Plano cargado ‚úÖ", "sys"); });
  bindDrop(el.dropRebar, (f) => { state.rebar = f; el.rebarName.textContent = f.name; bubble("Cartilla cargada ‚úÖ", "sys"); });

  el.btnClear.addEventListener("click", () => {
    state.plan = null; state.rebar = null; state.lastFiles = {};
    el.planName.textContent = "‚Äî";
    el.rebarName.textContent = "‚Äî";
    el.verifyStatus.textContent = "Listo. Carga ambos archivos y verifica.";
    el.findingsList.innerHTML = "";
    bubble("Limpio ‚úÖ", "sys");
  });

  function renderFindings(findings){
    el.findingsList.innerHTML = "";
    if(!findings || !findings.length){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = "<b>Sin hallazgos</b><div><small>No se reportaron discrepancias.</small></div>";
      el.findingsList.appendChild(it);
      return;
    }
    for(const f of findings){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;">
          <b>${(f.elemento||"Elemento")}</b>
          <small>${(f.severidad||"")}</small>
        </div>
        <div style="margin-top:6px">${(f.hallazgo||"")}</div>
        ${f.evidencia ? `<div style="margin-top:6px"><small>${f.evidencia}</small></div>` : ""}
      `;
      el.findingsList.appendChild(it);
    }
  }

  el.btnVerify.addEventListener("click", async () => {
    if(!state.plan || !state.rebar){
      bubble("Necesito plano y cartilla para verificar.", "sys");
      el.verifyStatus.textContent = "Faltan archivos (plano/cartilla).";
      return;
    }
    el.verifyStatus.textContent = "Verificando‚Ä¶";
    bubble("üß™ Verificando cartilla vs plano‚Ä¶", "sys");

    const fd = new FormData();
    fd.append("plan", state.plan, state.plan.name);
    fd.append("cartilla", state.rebar, state.rebar.name);
    fd.append("country", (el.country.value || "CO"));
    fd.append("standard", (el.standard.value || "NSR-10"));
    if(state.activeProjectId) fd.append("project_id", state.activeProjectId);

    try{
      const res = await fetch(`${API}/struct/verify`, { method:"POST", body: fd });
      const data = await res.json();
      if(!res.ok){
        bubble(`Error ${res.status}: ${data?.detail || "No se pudo verificar."}`, "sys");
        el.verifyStatus.textContent = "Error en verificaci√≥n.";
        return;
      }
      bubble(data.summary || "Verificaci√≥n lista ‚úÖ", "sys");
      renderFindings(data.findings || []);
      state.lastFiles = data.files || {};
      el.verifyStatus.textContent = "Verificaci√≥n lista ‚úÖ. Descarga el informe.";
    } catch(err){
      bubble("Error de red. Revisa el servidor.", "sys");
      el.verifyStatus.textContent = "Error de red.";
    }
  });

  async function download(kind){
    const fmap={pdf:"pdf",excel:"excel",word:"word"};
    const extmap={pdf:"pdf",excel:"xlsx",word:"docx"};
    const url=(state.lastFiles||{})[fmap[kind]];
    // Si hay archivo del verify, descarga directo
    if(url){
      const name=`TACTICA_${state.activeProjectId||"proyecto"}_estructural.${extmap[kind]}`;
      const res=await fetch(url);
      if(!res.ok){bubble("No pude descargar el archivo.","sys");return;}
      const blob=await res.blob();
      const a=document.createElement("a");
      const obj=URL.createObjectURL(blob);
      a.href=obj;a.download=name;
      document.body.appendChild(a);a.click();a.remove();
      setTimeout(()=>URL.revokeObjectURL(obj),4000);
    } else {
      // Si no hay archivo verificado, generar desde chat
      await generateReportFromChat(kind);
    }
  }

  el.dlPdf.addEventListener("click", () => download("pdf"));
  el.dlExcel.addEventListener("click", () => download("excel"));
  el.dlWord.addEventListener("click", () => download("word"));

  // chat
  async function sendChat(){
    const msg = (el.message.value || "").trim();
    if(!msg){ bubble("Escribe una pregunta.", "sys"); return; }
    el.message.value = "";
    bubble("T√∫: " + msg, "me");

    const fd = new FormData();
    fd.append("message", msg);
    fd.append("mode", "struct");
    fd.append("country", el.country.value || "CO");
    fd.append("standard", el.standard.value || "NSR-10");
    if(state.activeProjectId) fd.append("project_id", state.activeProjectId);
    // attach plan for context if exists
    if(state.plan) fd.append("file", state.plan, state.plan.name);

    try{
      const res = await fetch(`${API}/chat`, { method:"POST", body: fd });
      const data = await res.json();
      if(!res.ok){ bubble("Error: " + (data?.detail || "no se pudo responder"), "sys"); return; }
      bubble(data.response || "Sin respuesta", "sys");
    } catch(err){
      bubble("Error de red.", "sys");
    }
  }
  el.btnSend.addEventListener("click", sendChat);
  el.message.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault(); sendChat();
    }
  });

  // ‚îÄ‚îÄ VISOR DE PLANO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showPlanPreview(file){
    const wrap = document.getElementById("planVisorWrap");
    const visor = document.getElementById("planVisor");
    if(!wrap || !visor) return;
    const url = URL.createObjectURL(file);
    const ext = (file.name || "").toLowerCase();
    if(ext.endsWith(".pdf")){
      visor.innerHTML = `<iframe src="${url}" style="width:100%;height:300px;border:0;"></iframe>`;
    } else {
      visor.innerHTML = `<img src="${url}" alt="Plano estructural"/>`;
    }
    wrap.style.display = "block";
    el.dropPlan.style.display = "none";
  }

  // ‚îÄ‚îÄ VISOR DE CARTILLA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showRebarPreview(file){
    const wrap = document.getElementById("rebarVisorWrap");
    const visor = document.getElementById("rebarVisor");
    if(!wrap || !visor) return;
    const ext = (file.name || "").toLowerCase();
    // Excel/CSV: no se puede renderizar como imagen ‚Äî mostrar info en vez de visor
    if(ext.endsWith(".xlsx") || ext.endsWith(".xls") || ext.endsWith(".csv")){
      visor.innerHTML = `
        <div style="text-align:center;color:#fff;padding:20px;">
          <div style="font-size:40px;margin-bottom:12px;">üìä</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:6px;">${file.name}</div>
          <div style="font-size:12px;opacity:.6;">Archivo Excel/CSV cargado ‚Äî se enviar√° a la IA para an√°lisis</div>
        </div>`;
    } else if(ext.endsWith(".pdf")){
      const url = URL.createObjectURL(file);
      visor.innerHTML = `<iframe src="${url}" style="width:100%;height:300px;border:0;"></iframe>`;
    } else {
      // imagen
      const url = URL.createObjectURL(file);
      visor.innerHTML = `<img src="${url}" alt="Cartilla de hierro"/>`;
    }
    wrap.style.display = "block";
    el.dropRebar.style.display = "none";
  }

  // Enganchar preview a la carga de archivo (capture:true para no romper listener original)
  el.planInput.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(f) showPlanPreview(f);
  }, true);

  el.rebarInput.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if(f) showRebarPreview(f);
  }, true);

  // Drag & drop con preview
  el.dropPlan.addEventListener("drop", (e) => {
    const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) showPlanPreview(f);
  });
  el.dropRebar.addEventListener("drop", (e) => {
    const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) showRebarPreview(f);
  });

  // Botones quitar
  document.getElementById("btnQuitarPlano").addEventListener("click", () => {
    state.plan = null;
    el.planName.textContent = "";
    document.getElementById("planVisor").innerHTML = "";
    document.getElementById("planVisorWrap").style.display = "none";
    el.dropPlan.style.display = "block";
    bubble("Plano eliminado.", "sys");
  });
  document.getElementById("btnQuitarCartilla").addEventListener("click", () => {
    state.rebar = null;
    el.rebarName.textContent = "";
    document.getElementById("rebarVisor").innerHTML = "";
    document.getElementById("rebarVisorWrap").style.display = "none";
    el.dropRebar.style.display = "block";
    bubble("Cartilla eliminada.", "sys");
  });

  // ‚îÄ‚îÄ GENERAR INFORME DESDE CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function generateReportFromChat(format){
    // Si ya tenemos archivos del verify, descargar directamente
    const fmap = { pdf:"pdf", excel:"excel", word:"word" };
    const extmap = { pdf:"pdf", excel:"xlsx", word:"docx" };
    if(state.lastFiles && state.lastFiles[fmap[format]]){
      const url = state.lastFiles[fmap[format]];
      const res = await fetch(url);
      if(res.ok){
        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `TACTICA_estructural_${Date.now()}.${extmap[format]}`;
        document.body.appendChild(a); a.click(); a.remove();
        bubble(`‚úÖ Informe ${format.toUpperCase()} descargado.`, "sys");
        return;
      }
    }
    // Si no hay archivos previos: tomar texto del chat y generar informe
    const bubbles = el.chat.querySelectorAll(".bubble");
    if(!bubbles.length){ bubble("El chat est√° vac√≠o. Pregunta algo primero.", "sys"); return; }
    let allText = "";
    bubbles.forEach(b => { allText += b.textContent.trim() + "\n"; });
    const lines = allText.split("\n").filter(l => l.length > 8);
    const items = lines.map((l, i) => ({
      elemento: `An√°lisis IA ‚Äî l√≠nea ${i+1}`,
      hallazgo: l,
      severidad: /error|discrepan|falta|incumple/i.test(l) ? "alta" :
                 /verificar|revisar|atenci/i.test(l) ? "media" : "baja"
    }));
    bubble(`Generando informe ${format.toUpperCase()} desde el an√°lisis IA‚Ä¶`, "sys");
    const fd = new FormData();
    fd.append("data", JSON.stringify(items));
    fd.append("format", format);
    fd.append("titulo", "An√°lisis Estructural ‚Äî T√ÅCTICA INGENIER√çA");
    fd.append("subtitulo", `${el.country.value||"CO"} ¬∑ ${el.standard.value||"NSR-10"}`);
    fd.append("mode", "struct");
    if(state.activeProjectId) fd.append("project_id", state.activeProjectId);
    try{
      const res = await fetch(`${API}/report/generate`, { method:"POST", body:fd });
      const data = await res.json();
      if(!res.ok){ bubble(`Error generando informe: ${data?.detail||"Intenta verificar primero."}`, "sys"); return; }
      state.lastFiles = {...(state.lastFiles||{}), ...(data.files||{})};
      const url = (data.files||{})[format];
      if(url){
        const r2 = await fetch(url);
        const blob = await r2.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `TACTICA_estructural_${Date.now()}.${extmap[format]}`;
        document.body.appendChild(a); a.click(); a.remove();
        bubble(`‚úÖ Informe ${format.toUpperCase()} descargado.`, "sys");
      }
    } catch(err){ bubble("Error de red: " + err.message, "sys"); }
  }

  document.getElementById("btnRptPdf").addEventListener("click",   () => generateReportFromChat("pdf"));
  document.getElementById("btnRptExcel").addEventListener("click", () => generateReportFromChat("excel"));
  document.getElementById("btnRptWord").addEventListener("click",  () => generateReportFromChat("word"));

  // init
  bubble("Listo. Carga plano + cartilla y verifica. Luego pregunta lo que quieras.", "sys");
  loadProjects().catch(() => bubble("No pude cargar proyectos (backend).", "sys"));
})();
</script>
</body>
</html>
</body>
</html>